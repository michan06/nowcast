<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    <title>Nowcast</title>
<!-- <script src="js/jquery-3.3.1.min.js"></script> -->
<style>
body {
    padding: 0;
    margin: 0;
}
html, body, #map {
    height: 100%;
    width: 100vw;
}
</style>    
</head>
<body>
<div id="map"></div>
<script>
var nowCastLayer;
var himawariLayer;
var nowCastTimeList;
var himawariTimeList;
var isPlay = false;
var playInfoButton;
var map = L.map('map').fitWorld();
map.setView([35.653918,139.857864], 8);

map.locate({setView: true, maxZoom: 9});
function onLocationFound(e) {
    var radius = e.accuracy;
    L.circleMarker(e.latlng,{radius:10,color:'#FF'}).addTo(map);
        // .bindPopup("You are within " + radius + " meters from this point").openPopup();

    // L.circle(e.latlng, radius).addTo(map);
}
map.on('locationfound', onLocationFound);

//https://www.jma.go.jp/bosai/jmatile/data/nowc/20210405033000/none/20210405033000/surf/hrpns/10/910/404.png
var seamLessPhotoLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
//L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
})
seamLessPhotoLayer.addTo(map);
var stdLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
});
const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));

var baseLayers = {
    "Standard": stdLayer,
    "Seamless Photo": seamLessPhotoLayer
};

var overlays = {
    // "Nowcast": nowCastLayer,
    // "Himawari": himawariLayer
};

var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

var refreshButton  = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function(m) {
            var btn = L.DomUtil.create('button')
            btn.innerText = 'üîÑ'
            L.DomEvent.on(btn, 'click', function() {
                isPlay = false;
                refreshHimawari();
                refreshNowCast();
            })
            return btn
        }
    })
map.addControl(new refreshButton())

// https://gist.github.com/ejh/2935327
L.Control.layerButton = L.Control.extend({
    options: {
        position: 'bottomleft'
    },
    initialize: function (options) {
        this._button = {};
        this.setButton(options);
    },
    setButton: function (options) {
        var button = {
        'text': options.text,                 //string
        'iconUrl': options.iconUrl,           //string
        'onClick': options.onClick,           //callback function
        'hideText': !!options.hideText,         //forced bool
        'maxWidth': options.maxWidth || 70,     //number
        'doToggle': options.toggle,			//bool
        'toggleStatus': false					//bool
        };

        this._button = button;
        // this._update();
    },    
    onAdd: function(map) {
        // leaflet-buttons-control-toggleon
        this.button = L.DomUtil.create('button','leaflet-control-button');
        this.button.innerText = this._button.text;

        L.DomEvent
            .addListener(this.button, 'click', this._button.onClick,this)
        return this.button;
    },
    onRemove: function(map) {
        // Nothing to do here
    },
    setText: function (text) {
        this.button.innerText = text;
        this._button.text = text;

        return this._button.text;
    },
});

L.Control.buttonInfo = function(opts) {
    return new L.Control.layerButton(opts);
}
nowcastInfo = L.Control.buttonInfo({ position: 'bottomleft',text:'Nowcast', onClick:playNowCast })
nowcastInfo.addTo(map);
himawariInfo = L.Control.buttonInfo({ position: 'bottomleft',text:'Himawari',onClick:playHimawari })
himawariInfo.addTo(map);

// map.setView([35.653918,139.857864], 8);

refreshNowCast();
refreshHimawari();
window.setInterval(refreshHimawari, 150000);
window.setInterval(refreshNowCast, 300000);

async function refreshNowCast(){
    isPlay = false;
    nowCastTimeList = await fetch("https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json").then(function(response) {
        return response.json();
    });
    // console.log(nowCastTimeList);
    const baseTime = nowCastTimeList[0]['basetime'];
    const validTime = nowCastTimeList[0]['validtime'];
    const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");

    console.log(`${new Date()}:${validTime}:${baseTimeDt}`);
    const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
    console.log(url);
    if(!nowCastLayer){
        // 
        console.log(`new nowCastLayer`);
        nowCastLayer = L.tileLayer(url, {zIndex:20,maxNativeZoom:10,opacity:0.85,
            attribution:"<a href='https://www.jma.go.jp/bosai/nowc/' target='_blank'>Èõ®Èõ≤„ÅÆÂãï„Åç</a>"});
        nowCastLayer.addTo(map);
        layerControl.addOverlay(nowCastLayer,`Nowcast`);
    }else{
        console.log(`setUrl nowCastLayer`);
        nowCastLayer.setUrl(url);
    }
    nowcastInfo.setText(`‚òÇ ‚ñ∂:${baseTimeDt}`);
}

// https://www.jma.go.jp/bosai/himawari/data/satimg/20210406040000/jp/20210406040000/B13/TBB/6/54/26.jpg

async function refreshHimawari(){
    isPlay = false;
    himawariTimeList = await fetch("https://www.jma.go.jp/bosai/himawari/data/satimg/targetTimes_jp.json").then(function(response) {
        return response.json();
    });
    // console.log(himawariTimeList);
    const baseTime = himawariTimeList[himawariTimeList.length-1]['basetime'];
    const validTime = himawariTimeList[himawariTimeList.length-1]['validtime'];
    const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");
    console.log(`${new Date()}:${validTime}`);
    const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
    console.log(url);
    if(!himawariLayer){
        console.log(`new himawariLayer`);
        himawariLayer = L.tileLayer(url, {zIndex:10,maxNativeZoom:6,maxNativeZoom:6,opacity:0.70,
            attribution:"<a href='https://www.jma.go.jp/bosai/map.html#5/34.5/137/&elem=strengthen&contents=himawari' target='_blank'>Ê∞óË±°Ë°õÊòü„Å≤„Åæ„Çè„ÇäÈõ≤È†ÇÂº∑Ë™øÁîªÂÉè</a>"});
        himawariLayer.addTo(map);
        layerControl.addOverlay(himawariLayer,`Himawari`);
    }else{
        console.log(`setUrl himawariLayer`);
        himawariLayer.setUrl(url);
    }
    himawariInfo.setText(`‚òÅ ‚ñ∂:${baseTimeDt}`);

}

async function playNowCast(){
    if(isPlay){
        isPlay = false;
        return;
    }
    isPlay = true;
    const timelist = nowCastTimeList.sort(function (a, b) {
        return (a.baseTime < b.baseTime ? 1 : -1);
    })
    console.log(timelist);
    for(time of timelist ){
        const baseTime = time['basetime'];
        const validTime = time['validtime'];
        const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");
        console.log(`${new Date()}:${validTime}`);
        const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
        console.log(url);
        nowCastLayer.setUrl(url);
        var rest = 1000;
        while(nowCastLayer.isLoading()){
            await sleep(10);
            rest = rest - 10;
        }
        await sleep(rest);
        if(!isPlay){
            break;
        }
        nowcastInfo.setText(`‚òÇ ‚ñ∂:${baseTimeDt}`);

    }
    isPlay = false;
}

async function playHimawari(){
    if(isPlay){
        isPlay = false;
        return;
    }
    isPlay = true;
    // for(time of himawariTimeList){
    const timelist = nowCastTimeList.sort(function (a, b) {
        return (a.baseTime < b.baseTime ? 1 : -1);
    })

    for(time of timelist){
        const baseTime = time['basetime'];
        const validTime = time['validtime'];
        const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");
        console.log(`${new Date()}:${validTime}`);
        const url2 = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
        himawariLayer.setUrl(url2);
        var rest = 1000;
        while(himawariLayer.isLoading()){
            await sleep(10);
            rest = rest - 10;
        }
        await sleep(rest);
        if(!isPlay){
            break;
        }
        himawariInfo.setText(`‚òÅ ‚ñ∂:${baseTimeDt}`);
    }
    isPlay = false;
}

</script>
</body>
</html>
