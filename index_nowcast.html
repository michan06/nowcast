<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    <title>Nowcast</title>
<!-- <script src="js/jquery-3.3.1.min.js"></script> -->
<style>
body {
    padding: 0;
    margin: 0;
}
html, body, #map {
    height: 100%;
    width: 100vw;
}
</style>    
</head>
<body>
<div id="map"></div>
<script>
var nowCastLayer;
var himawariLayer;
var nowCastTimeList;
var himawariTimeList;
var isPlay = false;
var playInfoButton;
var map = L.map('map').fitWorld();
map.setView([35.653918,139.857864], 8);

map.locate({setView: true, maxZoom: 9});
function onLocationFound(e) {
    var radius = e.accuracy;
    L.circleMarker(e.latlng,{radius:10,color:'#FF'}).addTo(map);
        // .bindPopup("You are within " + radius + " meters from this point").openPopup();

    // L.circle(e.latlng, radius).addTo(map);
}
map.on('locationfound', onLocationFound);

//https://www.jma.go.jp/bosai/jmatile/data/nowc/20210405033000/none/20210405033000/surf/hrpns/10/910/404.png
var seamLessPhotoLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
//L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
})
seamLessPhotoLayer.addTo(map);
var stdLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
});
const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));

var baseLayers = {
    "Standard": stdLayer,
    "Seamless Photo": seamLessPhotoLayer
};

var overlays = {
    // "Nowcast": nowCastLayer,
    // "Himawari": himawariLayer
};

var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

var refreshButton  = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function(m) {
            var btn = L.DomUtil.create('button')
            btn.innerText = 'üîÑ'
            L.DomEvent.on(btn, 'click', function() {
                isPlay = false;
                refreshHimawari();
                refreshNowCast();
            })
            return btn
        }
    })
map.addControl(new refreshButton())

var NowcastButton = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function(m) {
            var btn = L.DomUtil.create('button')
            btn.innerText = '‚òÇ ‚ñ∂'
            L.DomEvent.on(btn, 'click', function() {
                if(!isPlay){
                    playNowCast();
                }else{
                    isPlay = false;
                }
            })
            return btn
        }
    })
map.addControl(new NowcastButton())

var himawariButton  = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function(m) {
            var btn = L.DomUtil.create('button')
            btn.innerText = '‚òÅ ‚ñ∂'
            L.DomEvent.on(btn, 'click', function() {
                if(!isPlay){
                    playHimawari();
                }else{
                    isPlay = false;
                }
            })
            return btn
        }
    })
map.addControl(new himawariButton())

// map.setView([35.653918,139.857864], 8);

refreshNowCast();
refreshHimawari();
window.setInterval(refreshHimawari, 150000);
window.setInterval(refreshNowCast, 300000);

async function refreshNowCast(){
    if(isPlay) return;
    nowCastTimeList = await fetch("https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json").then(function(response) {
        return response.json();
    });
    // console.log(nowCastTimeList);
    const baseTime = nowCastTimeList[0]['basetime'];
    const validTime = nowCastTimeList[0]['validtime'];
    const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");

    console.log(`${new Date()}:${validTime}:${baseTimeDt}`);
    const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
    console.log(url);
    if(!nowCastLayer){
        console.log(`new nowCastLayer`);
        nowCastLayer = L.tileLayer(url, {zIndex:20,maxNativeZoom:10,opacity:0.85});
        nowCastLayer.addTo(map);
        layerControl.addOverlay(nowCastLayer,`Nowcast(${baseTimeDt})`);
    }else{
        console.log(`setUrl nowCastLayer`);
        layerControl.removeLayer(nowCastLayer);
        layerControl.addOverlay(nowCastLayer,`Nowcast(${baseTimeDt})`);
        nowCastLayer.setUrl(url);
    }
}

// https://www.jma.go.jp/bosai/himawari/data/satimg/20210406040000/jp/20210406040000/B13/TBB/6/54/26.jpg

async function refreshHimawari(){
    if(isPlay) return;
    himawariTimeList = await fetch("https://www.jma.go.jp/bosai/himawari/data/satimg/targetTimes_jp.json").then(function(response) {
        return response.json();
    });
    // console.log(himawariTimeList);
    const baseTime = himawariTimeList[himawariTimeList.length-1]['basetime'];
    const validTime = himawariTimeList[himawariTimeList.length-1]['validtime'];
    const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");
    console.log(`${new Date()}:${validTime}`);
    const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
    console.log(url);
    if(!himawariLayer){
        console.log(`new himawariLayer`);
        himawariLayer = L.tileLayer(url, {zIndex:10,maxNativeZoom:6,maxNativeZoom:6,opacity:0.70});
        himawariLayer.addTo(map);
        layerControl.addOverlay(himawariLayer,`Himawari(${baseTimeDt})`);
    }else{
        console.log(`setUrl himawariLayer`);
        layerControl.removeLayer(himawariLayer);
        layerControl.addOverlay(himawariLayer,`Himawari(${baseTimeDt})`);
        himawariLayer.setUrl(url);
    }

}

async function playNowCast(){
    isPlay = true;
    const timelist = nowCastTimeList.sort(function (a, b) {
    return (a.baseTime < b.baseTime ? 1 : -1);
    })
    console.log(timelist);
    for(time of timelist ){
        const baseTime = time['basetime'];
        const validTime = time['validtime'];
        const baseTimeDt = moment(baseTime+" +0000", "YYYYMMDDhhmmss Z").format("YYYY/MM/DD hh:mm:ss");
        console.log(`${new Date()}:${validTime}`);
        const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
        console.log(url);
        nowCastLayer.setUrl(url);
        var rest = 1000;
        while(nowCastLayer.isLoading()){
            await sleep(10);
            rest = rest - 10;
        }
        await sleep(rest);
        if(!isPlay){
            if(playInfoButton) map.removeControl(playInfoButton)
            break;
        }

        if(playInfoButton) map.removeControl(playInfoButton)
        playInfo = L.Control.extend({
                options: {
                    position: 'topright'
                },
                onAdd: function(m) {
                    var btn = L.DomUtil.create('button')
                    btn.innerText = baseTimeDt
                    return btn
                }
            })
        playInfoButton = new playInfo()    
        map.addControl(playInfoButton)
    }
    if(playInfoButton) map.removeControl(playInfoButton)
    isPlay = false;
}

async function playHimawari(){
    isPlay = true;
    for(time of himawariTimeList){
        const baseTime = time['basetime'];
        const validTime = time['validtime'];
        console.log(`${new Date()}:${validTime}`);
        const url2 = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
        himawariLayer.setUrl(url2);
        var rest = 1000;
        while(himawariLayer.isLoading()){
            await sleep(10);
            rest = rest - 10;
        }
        await sleep(rest);
        if(!isPlay){
            if(playInfoButton) map.removeControl(playInfoButton)
            break;
        }
        if(playInfoButton) map.removeControl(playInfoButton)
        playInfo  = L.Control.extend({
                options: {
                    position: 'topright'
                },
                onAdd: function(m) {
                    var btn = L.DomUtil.create('button')
                    btn.innerText = baseTime
                    return btn
                }
            })
        playInfoButton = new playInfo()    
        map.addControl(playInfoButton)
    }
    if(playInfoButton) map.removeControl(playInfoButton)
    isPlay = false;

}

</script>
</body>
</html>
