<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous"></script>
    <title>Nowcast</title>
    <!-- <script src="js/jquery-3.3.1.min.js"></script> -->
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
            width: 100vw;
        }

        .fontLarge {
            font-size: x-large;
            padding: 0.35em;
            margin: 0.15em;
        }

        .leaflet-control-button {
            min-width: 200px;
            /* "Hide Himawari" ã«åˆã‚ã›ã¦å¹…ã‚’åºƒã’ã‚‹ */
            text-align: center;
            margin: 5px !important;
            white-space: nowrap;
            padding: 0.35em;
        }

        .bottom-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var nowCastLayer;
        var nowCastLayerArr = [];
        var himawariLayer;
        var himawariLayerArr = [];
        var nowCastTimeList;
        var himawariTimeList;
        var playTimelist;
        var isPlay = false;
        var playSpeed = 2; // å†ç”Ÿé€Ÿåº¦ (1: é€šå¸¸, 2: 2å€é€Ÿ, 4: 4å€é€Ÿ) - ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã§å®Ÿç¾
        var opacityNowCast = 0.65;//0.85;
        var opacityHimawari = 0.7;//0.7;
        var optHimawari = 'B13/TBB'; // 'B13/TBB'; // èµ¤å¤– //'REP/ETC' // ãƒˆã‚¥ãƒ«ãƒ¼ã‚«ãƒ©ãƒ¼
        var isManualHimawariMode = false; // æ‰‹å‹•ã§ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã—ãŸå ´åˆtrueï¼ˆè‡ªå‹•åˆ‡æ›¿ã‚’ç„¡åŠ¹åŒ–ï¼‰
        var lastIsDaytime = null; // å‰å›ã®æ˜¼å¤œçŠ¶æ…‹ï¼ˆæ˜¼å¤œåˆ‡æ›¿æ¤œçŸ¥ç”¨ï¼‰
        var playInfoButton;
        var map = L.map('map').fitWorld();
        map.setView([35.653918, 139.857864], 8);

        // ç¾åœ¨ä½ç½®ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ ï¼ˆå¤‰æ•°å®£è¨€éƒ¨åˆ†ã«è¿½åŠ ï¼‰
        var currentLocationMarker = null;

        // ç¾åœ¨ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        async function updateCurrentLocation() {
            try {
                const position = await getCurrentPosition();
                const latlng = L.latLng(position.coords.latitude, position.coords.longitude);

                // å‰å›ã®ä½ç½®ã¨æ¯”è¼ƒï¼ˆ100mä»¥ä¸Šç§»å‹•ã—ã¦ã„ã‚‹å ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
                const shouldScroll = currentLocationMarker === null ||
                    currentLocationMarker.getLatLng().distanceTo(latlng) > 100;

                // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
                if (currentLocationMarker) {
                    currentLocationMarker.setLatLng(latlng);
                } else {
                    currentLocationMarker = L.circleMarker(latlng, {
                        radius: 10,
                        color: '#800000'
                    }).addTo(map);
                }

                // ç§»å‹•è·é›¢ãŒ100mä»¥ä¸Šã®å ´åˆã€ãã®ä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (shouldScroll) {
                    map.setView(latlng, map.getZoom());
                }
            } catch (error) {
                console.warn('Error getting current location:', error);
            }
        }

        // Promiseç‰ˆã®geolocation API
        function getCurrentPosition(options = {}) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // æ—¢å­˜ã®onLocationFoundé–¢æ•°ã‚’ä¿®æ­£
        function onLocationFound(e) {
            const latlng = e.latlng;
            currentLocationMarker = L.circleMarker(latlng, {
                radius: 10,
                color: '#800000'
            }).addTo(map);
        }

        // å®šæœŸçš„ãªä½ç½®æƒ…å ±ã®æ›´æ–°ã‚’è¨­å®šï¼ˆ5åˆ†ã”ã¨ï¼‰
        window.setInterval(updateCurrentLocation, 300000);

        // åˆæœŸè¨­å®šéƒ¨åˆ†ã‚‚ä¿®æ­£
        map.locate({ setView: true, maxZoom: 8 });
        map.on('locationfound', onLocationFound);
        map.on('locationerror', function (e) {
            console.warn('Location error:', e);
        });

        // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ æ–¹å‘ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let startZoomLevel = 0;
        let zoomingIn = true;

        // ã‚ºãƒ¼ãƒ æ–¹å‘ã‚’æ¤œçŸ¥
        map.on('zoomstart', () => {
            startZoomLevel = map.getZoom();
        });

        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        map.on('zoomend', () => {
            const endZoomLevel = map.getZoom(); // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
            if (startZoomLevel < endZoomLevel) {
                zoomingIn = true;
            } else {
                zoomingIn = false;
            }

            if (endZoomLevel % 2 !== 0) { // å¥‡æ•°ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                const newZoomLevel = zoomingIn ? endZoomLevel + 1 : endZoomLevel - 1; // ã‚ºãƒ¼ãƒ æ–¹å‘ã«å¿œã˜ã¦èª¿æ•´
                console.log(`Adjusting zoom level from ${startZoomLevel} to ${endZoomLevel} => ${zoomingIn} = ${newZoomLevel}`);
                map.setZoom(newZoomLevel); // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´
            }
        });
        //https://www.jma.go.jp/bosai/jmatile/data/nowc/20210405033000/none/20210405033000/surf/hrpns/10/910/404.png
        // ç™½åœ°å›³ï¼ˆã²ã¾ã‚ã‚Šè¡¨ç¤ºæ™‚ç”¨ï¼‰
        var blankLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>"
        });
        // è¡›æ˜Ÿå†™çœŸï¼ˆã²ã¾ã‚ã‚Šéè¡¨ç¤ºæ™‚ç”¨ï¼‰
        var seamlessPhotoLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>"
        });
        blankLayer.addTo(map);
        const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));


        var refreshButton = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function (m) {
                var btn = L.DomUtil.create('button', 'leaflet-control-button fontLarge')
                btn.innerText = 'ğŸ”„'
                L.DomEvent.on(btn, 'click', function () {
                    isPlay = false;
                    // è‡ªå‹•åˆ‡æ›¿ã‚’å†æœ‰åŠ¹åŒ–
                    isManualHimawariMode = false;
                    console.log('Auto mode re-enabled by refresh button');
                    refreshHimawari();
                    refreshNowCast();
                })
                return btn
            }
        })
        map.addControl(new refreshButton())

        // https://gist.github.com/ejh/2935327
        L.Control.layerButton = L.Control.extend({
            options: {
                position: 'bottomleft'
            },
            initialize: function (options) {
                this._button = {};
                this.setButton(options);
            },
            setButton: function (options) {
                var button = {
                    'text': options.text,                 //string
                    'iconUrl': options.iconUrl,           //string
                    'onClick': options.onClick,           //callback function
                    'hideText': !!options.hideText,         //forced bool
                    'maxWidth': options.maxWidth || 70,     //number
                    'minWidth': options.minWidth || 70,     //number
                    'doToggle': options.toggle,			//bool
                    'toggleStatus': options.toggleStatus || false,					//bool
                    'position': options.position || 'bottomleft'					//bool
                };
                console.log(`${JSON.stringify(button)}`);
                this._button = button;
                // this._update();
            },
            onAdd: function (map) {
                // leaflet-buttons-control-toggleon
                this.button = L.DomUtil.create('button', 'leaflet-control-button fontLarge');
                this.button.innerText = this._button.text;
                this.button.position = this._button.position;
                // this.button.addClass('fontLarge');

                L.DomEvent
                    .addListener(this.button, 'click', this.onClick, this)
                // .addListener(this.button, 'click', this._button.onClick,this)
                return this.button;
            },
            onRemove: function (map) {
                // Nothing to do here
            },
            setText: function (text) {
                this.button.innerText = text;
                this._button.text = text;

                return this._button.text;
            },
            onClick: function () {
                console.log(`onclick:${this._button.toggleStatus}`);
                this._button.onClick();
                this._button.toggleStatus = !this._button.toggleStatus;
            },
            getToggleStatus: function () {
                console.log('getToggleStatus');
                return (this._button.toggleStatus);
            },
        });

        L.Control.buttonInfo = function (opts) {
            return new L.Control.layerButton(opts);
        }

        // å†ç”Ÿãƒœã‚¿ãƒ³ã¨é€Ÿåº¦ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        var playControlGroup = L.Control.extend({
            options: {
                position: 'bottomleft'
            },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar');
                container.style.display = 'flex';
                container.style.flexDirection = 'row';

                // å†ç”Ÿãƒœã‚¿ãƒ³
                this.playButton = L.DomUtil.create('button', 'leaflet-control-button fontLarge', container);
                this.playButton.innerText = 'Nowcast';
                this.playButton.style.minWidth = '200px';
                L.DomEvent.on(this.playButton, 'click', playBoth);

                // é€Ÿåº¦ãƒœã‚¿ãƒ³
                this.speedButton = L.DomUtil.create('button', 'leaflet-control-button fontLarge', container);
                this.speedButton.innerText = '2x';
                this.speedButton.style.minWidth = '50px';
                L.DomEvent.on(this.speedButton, 'click', toggleSpeed);

                return container;
            },
            setPlayText: function (text) {
                this.playButton.innerText = text;
            },
            setSpeedText: function (text) {
                this.speedButton.innerText = text;
            }
        });

        var playControl = new playControlGroup();
        playControl.addTo(map);

        // nowcastInfoã¨speedButtonã®äº’æ›æ€§ã®ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼
        nowcastInfo = {
            setText: function (text) { playControl.setPlayText(text); },
            _button: { text: '' }
        };
        speedButton = {
            setText: function (text) { playControl.setSpeedText(text); }
        };

        nowcastButton = L.Control.buttonInfo({ position: 'topright', text: 'Hide Nowcast', toggle: true, toggleStatus: true, onClick: toggleNowCast })
        nowcastButton.addTo(map);
        himawariButton = L.Control.buttonInfo({ position: 'topright', text: 'Hide Himawari', toggle: true, toggleStatus: true, onClick: toggleHimawari })
        himawariButton.addTo(map);

        trueColorButton = L.Control.buttonInfo({ position: 'bottomleft', text: 'TrueColor', toggle: true, toggleStatus: true, onClick: toggleTrueColor })
        trueColorButton.addTo(map);

        // map.setView([35.653918,139.857864], 8);

        refreshNowCast();
        refreshHimawari();
        window.setInterval(refreshHimawari, 150000);
        window.setInterval(refreshNowCast, 300000);

        function toggleNowCast() {
            if (nowcastButton.getToggleStatus()) {
                nowcastButton.setText('Show Nowcast');
                console.log('toggle to off');
                nowCastLayer.setOpacity(0);
                nowCastLayerArr[0].setOpacity(0);
                nowCastLayerArr[1].setOpacity(0);
            } else {
                nowcastButton.setText('Hide Nowcast');
                nowCastLayer.setOpacity(opacityNowCast);
                console.log('toggle to on');
            }
        }
        function toggleHimawari() {
            if (himawariButton.getToggleStatus()) {
                himawariButton.setText('Show Himawari');
                console.log('toggle to off');
                himawariLayer.setOpacity(0);
                himawariLayerArr[0].setOpacity(0);
                himawariLayerArr[1].setOpacity(0);
                // è¡›æ˜Ÿå†™çœŸã«åˆ‡ã‚Šæ›¿ãˆ
                map.removeLayer(blankLayer);
                seamlessPhotoLayer.addTo(map);
            } else {
                himawariButton.setText('Hide Himawari');
                himawariLayer.setOpacity(opacityHimawari);
                console.log('toggle to on');
                // ç™½åœ°å›³ã«åˆ‡ã‚Šæ›¿ãˆ
                map.removeLayer(seamlessPhotoLayer);
                blankLayer.addTo(map);
            }
        }

        function toggleTrueColor() {
            // æ‰‹å‹•åˆ‡æ›¿ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆï¼ˆè‡ªå‹•åˆ‡æ›¿ã‚’ç„¡åŠ¹åŒ–ï¼‰
            isManualHimawariMode = true;

            if (optHimawari === 'B13/TBB') {
                trueColorButton.setText('TrueColor');
                optHimawari = 'REP/ETC';
            } else {
                trueColorButton.setText('IR');
                optHimawari = 'B13/TBB';
            }
            console.log(`Manual switch to ${optHimawari}`);
            refreshHimawari();
        }

        // å†ç”Ÿé€Ÿåº¦åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function toggleSpeed() {
            if (playSpeed === 1) {
                playSpeed = 2;
                speedButton.setText('2x');
            } else if (playSpeed === 2) {
                playSpeed = 4;
                speedButton.setText('4x');
            } else {
                playSpeed = 1;
                speedButton.setText('1x');
            }
            console.log(`Play speed changed to ${playSpeed}x`);
        }

        // è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆç”¨ã®é–¢æ•°ã‚’è¿½åŠ 
        function updateHimawariMode() {
            const now = new Date();
            const hour = now.getHours();
            const isDaytime = hour >= 5 && hour < 18;

            // æ˜¼å¤œãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰è‡ªå‹•åˆ‡æ›¿ã‚’å†æœ‰åŠ¹åŒ–
            if (lastIsDaytime !== null && lastIsDaytime !== isDaytime) {
                isManualHimawariMode = false;
                console.log('Auto mode re-enabled by day/night transition');
            }
            lastIsDaytime = isDaytime;

            // æ‰‹å‹•ã§åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã¯è‡ªå‹•åˆ‡æ›¿ã—ãªã„
            if (isManualHimawariMode) {
                return;
            }

            if (isDaytime && optHimawari === 'B13/TBB') {
                // æ˜¼é–“ãªã®ã«IRãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€TrueColorã«åˆ‡ã‚Šæ›¿ãˆ
                optHimawari = 'REP/ETC';
                trueColorButton.setText('TrueColor');
                console.log('Auto switching to TrueColor (daytime)');
                refreshHimawari();
            } else if (!isDaytime && optHimawari === 'REP/ETC') {
                // å¤œé–“ãªã®ã«TrueColorãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€IRã«åˆ‡ã‚Šæ›¿ãˆ
                optHimawari = 'B13/TBB';
                trueColorButton.setText('IR');
                console.log('Auto switching to IR (nighttime)');
                refreshHimawari();
            }
        }

        async function refreshNowCast() {
            isPlay = false;
            nowCastTimeList = await fetch("https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json").then(function (response) {
                return response.json();
            });
            playTimelist = JSON.parse(JSON.stringify(nowCastTimeList));
            playTimelist.sort(function (a, b) {
                return (a.baseTime < b.baseTime ? 1 : -1);
            })

            // console.log(nowCastTimeList);
            const baseTime = nowCastTimeList[0]['basetime'];
            const validTime = nowCastTimeList[0]['validtime'];
            const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");

            console.log(`${new Date()}:${validTime}:${baseTimeDt}`);
            const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
            console.log(url);
            if (!nowCastLayer) {
                // 
                console.log(`new nowCastLayer`);
                nowCastLayer = L.tileLayer(url, {
                    zIndex: 20, maxNativeZoom: 10, opacity: opacityNowCast,
                    attribution: "<a href='https://www.jma.go.jp/bosai/nowc/' target='_blank'>é›¨é›²ã®å‹•ã</a>"
                });
                nowCastLayer.addTo(map);
                // layerControl.addOverlay(nowCastLayer,`Nowcast`);
                nowCastLayerArr[0] = nowCastLayer;
                nowCastLayerArr[1] = L.tileLayer(url, {
                    zIndex: 20, maxNativeZoom: 10, opacity: opacityNowCast,
                    attribution: "<a href='https://www.jma.go.jp/bosai/nowc/' target='_blank'>é›¨é›²ã®å‹•ã</a>"
                });
                nowCastLayerArr[1].setOpacity(0);
                nowCastLayerArr[1].addTo(map)
            } else {
                if (nowcastButton.getToggleStatus()) {
                    if (nowCastLayer === nowCastLayerArr[1]) {
                        nowCastLayer = nowCastLayerArr[0];
                        nowCastLayerArr[0].setOpacity(0);
                        nowCastLayerArr[1].setOpacity(opacityNowCast);
                    } else {
                        nowCastLayer = nowCastLayerArr[1];
                        nowCastLayerArr[1].setOpacity(0);
                        nowCastLayerArr[0].setOpacity(opacityNowCast);
                    }
                }
                console.log(`setUrl nowCastLayer`);
                nowCastLayer.setUrl(url);
                while (nowCastLayer.isLoading()) {
                    await sleep(10);
                }
                if (nowcastButton.getToggleStatus()) {
                    if (nowCastLayer === nowCastLayerArr[1]) {
                        nowCastLayerArr[1].setOpacity(opacityNowCast);
                        nowCastLayerArr[0].setOpacity(0);
                    } else {
                        nowCastLayerArr[0].setOpacity(opacityNowCast);
                        nowCastLayerArr[1].setOpacity(0);
                    }
                }
            }
            nowcastInfo.setText(`â–¶:${baseTimeDt}`);
        }

        // https://www.jma.go.jp/bosai/himawari/data/satimg/20210406040000/jp/20210406040000/B13/TBB/6/54/26.jpg

        async function refreshHimawari() {
            updateHimawariMode(); // æ›´æ–°æ™‚ã«ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
            isPlay = false;
            himawariTimeList = await fetch("https://www.jma.go.jp/bosai/himawari/data/satimg/targetTimes_jp.json").then(function (response) {
                return response.json();
            });
            // console.log(himawariTimeList);
            const baseTime = himawariTimeList[himawariTimeList.length - 1]['basetime'];
            const validTime = himawariTimeList[himawariTimeList.length - 1]['validtime'];
            const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");
            console.log(`${new Date()}:${validTime}`);
            // const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
            const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/{z}/{x}/{y}.jpg`;
            console.log(url);
            if (!himawariLayer) {
                console.log(`new himawariLayer`);
                himawariLayer = L.tileLayer(url, {
                    zIndex: 10, maxNativeZoom: 6, opacity: opacityHimawari,
                    attribution: "<a href='https://www.jma.go.jp/bosai/map.html#5/34.5/137/&elem=strengthen&contents=himawari' target='_blank'>æ°—è±¡è¡›æ˜Ÿã²ã¾ã‚ã‚Šèµ¤å¤–ç”»åƒ</a>"
                });
                himawariLayer.addTo(map);
                // layerControl.addOverlay(himawariLayer,`Himawari`);
                himawariLayerArr[0] = himawariLayer;
                himawariLayerArr[1] = L.tileLayer(url, {
                    zIndex: 10, maxNativeZoom: 6, opacity: opacityHimawari,
                    attribution: "<a href='https://www.jma.go.jp/bosai/map.html#5/34.5/137/&elem=strengthen&contents=himawari' target='_blank'>æ°—è±¡è¡›æ˜Ÿã²ã¾ã‚ã‚Šèµ¤å¤–ç”»åƒ</a>"
                });
                himawariLayerArr[1].setOpacity(0);
                himawariLayerArr[1].addTo(map);
            } else {
                if (himawariButton.getToggleStatus()) {
                    if (himawariLayer === himawariLayerArr[1]) {
                        himawariLayer = himawariLayerArr[0];
                        himawariLayerArr[0].setOpacity(0);
                        himawariLayerArr[1].setOpacity(opacityHimawari);
                    } else {
                        himawariLayer = himawariLayerArr[1];
                        himawariLayerArr[1].setOpacity(0);
                        himawariLayerArr[0].setOpacity(opacityHimawari);
                    }
                }
                console.log(`setUrl himawariLayer`);
                himawariLayer.setUrl(url);
                if (himawariButton.getToggleStatus()) {
                    if (himawariLayer === himawariLayerArr[1]) {
                        himawariLayerArr[0].setOpacity(0);
                        himawariLayerArr[1].setOpacity(opacityHimawari);
                    } else {
                        himawariLayerArr[0].setOpacity(opacityHimawari);
                        himawariLayerArr[1].setOpacity(0);
                    }
                }
            }
            //    himawariInfo.setText(`â–¶:${baseTimeDt}`);

        }

        async function playBoth() {
            if (isPlay) {
                isPlay = false;
                return;
            }
            isPlay = true;

            // å†ç”Ÿé–‹å§‹æ™‚ã«â– ã‚’è¡¨ç¤º
            nowcastInfo.setText('â–  åœæ­¢');

            // playSpeedåˆ†ã‚¹ã‚­ãƒƒãƒ—ã—ãªãŒã‚‰ãƒ«ãƒ¼ãƒ—ï¼ˆ2xãªã‚‰1ã¤é£›ã°ã—ã€4xãªã‚‰3ã¤é£›ã°ã—ï¼‰
            for (let i = 0; i < playTimelist.length; i += playSpeed) {
                const time = playTimelist[i];
                try {
                    const baseTime = time['basetime'];
                    const validTime = time['validtime'];
                    const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");

                    // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèªã‚’äº‹å‰ã«è¡Œã†
                    const nowcastUrl = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/8/227/99.png`;
                    const himawariUrl = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/4/13/6.jpg`;

                    const [nowcastExists, himawariExists] = await Promise.all([
                        fetch(nowcastUrl, { method: 'HEAD' }).then(res => res.ok).catch(() => false),
                        fetch(himawariUrl, { method: 'HEAD' }).then(res => res.ok).catch(() => false)
                    ]);

                    if (!nowcastExists || !himawariExists) {
                        console.log(`Skipping frame due to missing data: ${baseTimeDt}`);
                        continue;
                    }

                    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ›´æ–°
                    const fullNowcastUrl = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
                    const fullHimawariUrl = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/{z}/{x}/{y}.jpg`;

                    if (nowcastButton.getToggleStatus()) {
                        if (nowCastLayer === nowCastLayerArr[0]) {
                            nowCastLayer = nowCastLayerArr[1];
                            nowCastLayerArr[1].setOpacity(0);
                            nowCastLayerArr[0].setOpacity(opacityNowCast);
                        } else {
                            nowCastLayer = nowCastLayerArr[0];
                            nowCastLayerArr[0].setOpacity(0);
                            nowCastLayerArr[1].setOpacity(opacityNowCast);
                        }
                    }
                    if (himawariButton.getToggleStatus()) {
                        if (himawariLayer === himawariLayerArr[0]) {
                            himawariLayer = himawariLayerArr[1];
                            himawariLayerArr[1].setOpacity(0);
                            himawariLayerArr[0].setOpacity(opacityHimawari);
                        } else {
                            himawariLayer = himawariLayerArr[0];
                            himawariLayerArr[0].setOpacity(0);
                            himawariLayerArr[1].setOpacity(opacityHimawari);
                        }
                    }

                    // URLã®è¨­å®šã¨èª­ã¿è¾¼ã¿å®Œäº†å¾…ã¡
                    const loadPromises = [];
                    if (nowcastExists) {
                        nowCastLayer.setUrl(fullNowcastUrl);
                        loadPromises.push(waitForLayerLoad(nowCastLayer));
                    }
                    if (himawariExists) {
                        himawariLayer.setUrl(fullHimawariUrl);
                        loadPromises.push(waitForLayerLoad(himawariLayer));
                    }

                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Loading timeout')), 5000)
                    );

                    await Promise.race([
                        Promise.all(loadPromises),
                        timeoutPromise
                    ]).catch(error => {
                        console.warn('Layer loading error:', error);
                        return false;
                    });

                    await sleep(500);
                    if (!isPlay) break;

                    nowcastInfo.setText(`â– ${playSpeed}x:${baseTimeDt}`);

                } catch (error) {
                    console.warn('Error in animation frame:', error);
                    continue; // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
            }

            // æœ€å¾Œã®ãƒ•ãƒ¬ãƒ¼ãƒ ã®é€æ˜åº¦ã‚’é©åˆ‡ã«è¨­å®š
            if (nowcastButton.getToggleStatus()) {
                if (nowCastLayer === nowCastLayerArr[0]) {
                    nowCastLayerArr[0].setOpacity(opacityNowCast);
                    nowCastLayerArr[1].setOpacity(0);
                } else {
                    nowCastLayerArr[1].setOpacity(opacityNowCast);
                    nowCastLayerArr[0].setOpacity(0);
                }
            }
            if (himawariButton.getToggleStatus()) {
                if (himawariLayer === himawariLayerArr[0]) {
                    himawariLayerArr[0].setOpacity(opacityHimawari);
                    himawariLayerArr[1].setOpacity(0);
                } else {
                    himawariLayerArr[1].setOpacity(opacityHimawari);
                    himawariLayerArr[0].setOpacity(0);
                }
            }
            isPlay = false;

            // å†ç”Ÿçµ‚äº†å¾Œã«â–¶ã¨æœ€æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
            if (nowCastTimeList && nowCastTimeList.length > 0) {
                const baseTime = nowCastTimeList[0]['basetime'];
                const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");
                nowcastInfo.setText(`â–¶:${baseTimeDt}`);
            } else {
                nowcastInfo.setText('â–¶ å†ç”Ÿ');
            }
        }

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function waitForLayerLoad(layer) {
            return new Promise((resolve) => {
                if (!layer.isLoading()) {
                    resolve();
                    return;
                }
                const checkLoading = async () => {
                    while (layer.isLoading()) {
                        await sleep(10);
                    }
                    resolve();
                };
                checkLoading();
            });
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã®å¾Œã«è¿½åŠ ï¼‰
        updateHimawariMode();

        // å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆ5åˆ†ã”ã¨ï¼‰
        window.setInterval(updateHimawariMode, 300000);

        // ãƒãƒ¼ã‚«ãƒ¼ã¨ä½ç½®æƒ…å ±ã®è¨­å®š
        [
            [34.819916, 135.504041], // é’å±±å°
            [37.014244, 138.652698], // æ´¥å—
            [36.881936, 138.638919]  // å¤§èµ¤æ²¢
        ].forEach(coords => {
            L.circleMarker(coords, { radius: 7, color: '#800000' }).addTo(map);
        });

    </script>
</body>

</html>