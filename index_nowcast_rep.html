<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.css" crossorigin="" />
    <script type="importmap">
        {
            "imports": {
                "leaflet": "https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.js"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous"></script>
    <title>Nowcast</title>
    <!-- <script src="js/jquery-3.3.1.min.js"></script> -->
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
            width: 100vw;
        }

        .fontLarge {
            font-size: large;
            padding: 0.5em 0.8em;
            margin: 0.1em;
        }

        .leaflet-control-button {
            min-width: 140px;
            text-align: center;
            white-space: nowrap;
            background: rgba(30, 30, 30, 0.85);
            color: #fff;
            border: none;
            border-radius: 6px;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .leaflet-control-button:hover {
            background: rgba(60, 60, 60, 0.9);
        }

        .leaflet-control-button:active {
            transform: scale(0.97);
        }

        /* Leaflet„Ç∫„Éº„É†„Éú„Çø„É≥„ÅÆ„ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû */
        .leaflet-control-zoom {
            border: none !important;
            border-radius: 6px !important;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
        }

        .leaflet-control-zoom a {
            background: rgba(30, 30, 30, 0.85) !important;
            color: #fff !important;
            border: none !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
            transition: background 0.2s;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(60, 60, 60, 0.9) !important;
            color: #fff !important;
        }

        .leaflet-control-zoom-in {
            border-radius: 6px 6px 0 0 !important;
        }

        .leaflet-control-zoom-out {
            border-radius: 0 0 6px 6px !important;
        }

        /* „Éà„Ç∞„É´„Éú„Çø„É≥OFFÁä∂ÊÖã */
        .leaflet-control-button.toggle-off {
            background: rgba(30, 30, 30, 0.5);
            color: rgba(255, 255, 255, 0.5);
        }

        .leaflet-control-button.toggle-off:hover {
            background: rgba(50, 50, 50, 0.6);
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="module">
        import {
            Map as LeafletMap,
            TileLayer,
            Control,
            DomUtil,
            DomEvent,
            CircleMarker,
            LatLng
        } from 'leaflet';

        var nowCastLayer;
        var nowCastLayerArr = [];
        var himawariLayer;
        var himawariLayerArr = [];
        var nowCastTimeList;
        var himawariTimeList;
        var playTimelist;
        var isPlay = false;
        var playSpeed = 2; // ÂÜçÁîüÈÄüÂ∫¶ (1: ÈÄöÂ∏∏, 2: 2ÂÄçÈÄü, 4: 4ÂÄçÈÄü) - „Éï„É¨„Éº„É†„Çπ„Ç≠„ÉÉ„Éó„ÅßÂÆüÁèæ
        var opacityNowCast = 0.65;//0.85;
        var opacityHimawari = 0.7;//0.7;
        var optHimawari = 'B13/TBB'; // 'B13/TBB'; // Ëµ§Â§ñ //'REP/ETC' // „Éà„Ç•„É´„Éº„Ç´„É©„Éº
        var isManualHimawariMode = false; // ÊâãÂãï„Åß„É¢„Éº„ÉâÂàáÊõø„Åó„ÅüÂ†¥ÂêàtrueÔºàËá™ÂãïÂàáÊõø„ÇíÁÑ°ÂäπÂåñÔºâ
        var lastIsDaytime = null; // ÂâçÂõû„ÅÆÊòºÂ§úÁä∂ÊÖãÔºàÊòºÂ§úÂàáÊõøÊ§úÁü•Áî®Ôºâ
        var playInfoButton;
        var nowcastInfo;
        var speedButton;
        var nowcastButton;
        var himawariButton;
        var trueColorButton;
        var map = new LeafletMap('map').fitWorld();
        map.setView([35.653918, 139.857864], 8);

        // ÁèæÂú®‰ΩçÁΩÆ„ÅÆ„Éû„Éº„Ç´„Éº„Çí‰øùÊåÅ„Åô„ÇãÂ§âÊï∞„ÇíËøΩÂä†ÔºàÂ§âÊï∞ÂÆ£Ë®ÄÈÉ®ÂàÜ„Å´ËøΩÂä†Ôºâ
        var currentLocationMarker = null;

        // ÁèæÂú®‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        async function updateCurrentLocation() {
            try {
                const position = await getCurrentPosition();
                const latlng = new LatLng(position.coords.latitude, position.coords.longitude);

                // ÂâçÂõû„ÅÆ‰ΩçÁΩÆ„Å®ÊØîËºÉÔºà100m‰ª•‰∏äÁßªÂãï„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„Å´„Çπ„ÇØ„É≠„Éº„É´Ôºâ
                const shouldScroll = currentLocationMarker === null ||
                    currentLocationMarker.getLatLng().distanceTo(latlng) > 100;

                // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞„Åæ„Åü„ÅØÊñ∞Ë¶è‰ΩúÊàê
                if (currentLocationMarker) {
                    currentLocationMarker.setLatLng(latlng);
                } else {
                    currentLocationMarker = new CircleMarker(latlng, {
                        radius: 10,
                        color: '#800000'
                    }).addTo(map);
                }

                // ÁßªÂãïË∑ùÈõ¢„Åå100m‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÄÅ„Åù„ÅÆ‰ΩçÁΩÆ„Å´„Çπ„ÇØ„É≠„Éº„É´
                if (shouldScroll) {
                    map.setView(latlng, map.getZoom());
                }
            } catch (error) {
                console.warn('Error getting current location:', error);
            }
        }

        // PromiseÁâà„ÅÆgeolocation API
        function getCurrentPosition(options = {}) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // Êó¢Â≠ò„ÅÆonLocationFoundÈñ¢Êï∞„Çí‰øÆÊ≠£
        function onLocationFound(e) {
            const latlng = e.latlng;
            currentLocationMarker = new CircleMarker(latlng, {
                radius: 10,
                color: '#800000'
            }).addTo(map);
        }

        // ÂÆöÊúüÁöÑ„Å™‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÊõ¥Êñ∞„ÇíË®≠ÂÆöÔºà5ÂàÜ„Åî„Å®Ôºâ
        window.setInterval(updateCurrentLocation, 300000);

        // ÂàùÊúüË®≠ÂÆöÈÉ®ÂàÜ„ÇÇ‰øÆÊ≠£
        map.locate({ setView: true, maxZoom: 8 });
        map.on('locationfound', onLocationFound);
        map.on('locationerror', function (e) {
            console.warn('Location error:', e);
        });

        // „Éä„Ç¶„Ç≠„É£„Çπ„Éà„É¨„Ç§„É§„Éº„ÅÆmaxNativeZoom„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        // Ê∞óË±°Â∫Å„ÅÆ„Éä„Ç¶„Ç≠„É£„Çπ„Éà„Çø„Ç§„É´„ÅØÂÅ∂Êï∞„Ç∫„Éº„É†„É¨„Éô„É´„ÅÆ„ÅøÊèê‰æõ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ
        // Â•áÊï∞„Ç∫„Éº„É†„É¨„Éô„É´„Åß„ÅØ1„Å§‰∏ã„ÅÆÂÅ∂Êï∞„É¨„Éô„É´„ÅÆ„Çø„Ç§„É´„ÇíÊã°Â§ßË°®Á§∫„Åô„Çã
        let currentMaxNativeZoom = 10;

        function calculateMaxNativeZoom(zoomLevel) {
            // Â•áÊï∞„Å™„Çâ1„Å§‰∏ã„ÅÆÂÅ∂Êï∞„Å´„ÄÅÂÅ∂Êï∞„Å™„Çâ„Åù„ÅÆ„Åæ„ÅæÔºà„Åü„Å†„ÅóÊúÄÂ§ß10Ôºâ
            return Math.min(zoomLevel - (zoomLevel % 2), 10);
        }

        function updateNowCastMaxNativeZoom(zoomLevel) {
            const maxNative = calculateMaxNativeZoom(zoomLevel);

            // ÂÄ§„ÅåÂ§â„Çè„Çâ„Å™„Åë„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (maxNative === currentMaxNativeZoom) {
                return;
            }
            currentMaxNativeZoom = maxNative;

            nowCastLayerArr.forEach(layer => {
                if (layer && layer.options) {
                    layer.options.maxNativeZoom = maxNative;
                    layer.redraw();
                }
            });
            console.log(`Updated nowcast maxNativeZoom to ${maxNative} for zoom level ${zoomLevel}`);
        }

        // „Ç∫„Éº„É†ÈñãÂßãÂâç„ÅÆ„É¨„Éô„É´„ÇíË®òÈå≤
        let zoomStartLevel = 0;
        map.on('zoomstart', () => {
            zoomStartLevel = map.getZoom();
        });

        // „Ç∫„Éº„É†„É¨„Éô„É´Â§âÊõ¥ÊôÇ„Å´maxNativeZoom„ÇíÊõ¥Êñ∞
        map.on('zoom', () => {
            const currentZoom = map.getZoom();
            // „Ç∫„Éº„É†„Ç§„É≥„ÅÆÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Êõ¥Êñ∞ÔºàÈ´òËß£ÂÉèÂ∫¶„Çø„Ç§„É´„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅÔºâ
            if (currentZoom > zoomStartLevel) {
                updateNowCastMaxNativeZoom(currentZoom);
            }
        });

        map.on('zoomend', () => {
            updateNowCastMaxNativeZoom(map.getZoom());
        });
        //https://www.jma.go.jp/bosai/jmatile/data/nowc/20210405033000/none/20210405033000/surf/hrpns/10/910/404.png
        // ÁôΩÂú∞Âõ≥Ôºà„Å≤„Åæ„Çè„ÇäË°®Á§∫ÊôÇÁî®Ôºâ
        var blankLayer = new TileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
        });
        // Ë°õÊòüÂÜôÁúüÔºà„Å≤„Åæ„Çè„ÇäÈùûË°®Á§∫ÊôÇÁî®Ôºâ
        var seamlessPhotoLayer = new TileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢„Çø„Ç§„É´</a>"
        });
        blankLayer.addTo(map);
        const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));


        class RefreshButton extends Control {
            constructor() {
                super({ position: 'topleft' });
            }
            onAdd(m) {
                var btn = DomUtil.create('button', 'leaflet-control-button fontLarge')
                btn.innerText = 'üîÑ'
                btn.style.minWidth = '50px';
                DomEvent.on(btn, 'click', function () {
                    isPlay = false;
                    // Ëá™ÂãïÂàáÊõø„ÇíÂÜçÊúâÂäπÂåñ
                    isManualHimawariMode = false;
                    console.log('Auto mode re-enabled by refresh button');
                    refreshHimawari();
                    refreshNowCast();
                    // ÂàùÂõû‰ΩçÁΩÆÂèñÂæóÊàêÂäüÊôÇ„ÅÆ„ÅøÁèæÂú®‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    if (currentLocationMarker) {
                        updateCurrentLocation();
                    }
                })
                return btn
            }
        }
        map.addControl(new RefreshButton())

        // https://gist.github.com/ejh/2935327
        class LayerButton extends Control {
            _button = {};
            button = null;

            constructor(options) {
                super({ position: options.position || 'bottomleft' });
                this.setButton(options);
            }

            setButton(options) {
                var button = {
                    'text': options.text,                 //string
                    'iconUrl': options.iconUrl,           //string
                    'onClick': options.onClick,           //callback function
                    'hideText': !!options.hideText,         //forced bool
                    'maxWidth': options.maxWidth || 70,     //number
                    'minWidth': options.minWidth || 70,     //number
                    'doToggle': options.toggle,			//bool
                    'toggleStatus': options.toggleStatus || false,					//bool
                    'position': options.position || 'bottomleft'					//bool
                };
                console.log(`${JSON.stringify(button)}`);
                this._button = button;
            }

            onAdd(map) {
                // leaflet-buttons-control-toggleon
                this.button = DomUtil.create('button', 'leaflet-control-button fontLarge');
                this.button.innerText = this._button.text;
                this.button.position = this._button.position;

                DomEvent.on(this.button, 'click', this.onClick, this);
                return this.button;
            }

            onRemove(map) {
                // Nothing to do here
            }

            setText(text) {
                this.button.innerText = text;
                this._button.text = text;
                return this._button.text;
            }

            onClick() {
                console.log(`onclick:${this._button.toggleStatus}`);
                this._button.onClick();
                this._button.toggleStatus = !this._button.toggleStatus;
            }

            getToggleStatus() {
                console.log('getToggleStatus');
                return (this._button.toggleStatus);
            }
        }

        function createButtonInfo(opts) {
            return new LayerButton(opts);
        }

        // ÂÜçÁîü„Éú„Çø„É≥„Å®ÈÄüÂ∫¶„Éú„Çø„É≥„ÇíÊ®™‰∏¶„Å≥„Å´„Åô„Çã„Ç≥„É≥„Éà„É≠„Éº„É´
        class PlayControlGroup extends Control {
            playButton = null;
            speedButton = null;

            constructor() {
                super({ position: 'bottomleft' });
            }

            onAdd(map) {
                var container = DomUtil.create('div', 'leaflet-bar');
                container.style.display = 'flex';
                container.style.flexDirection = 'row';
                container.style.gap = '4px';
                container.style.background = 'transparent';
                container.style.border = 'none';
                container.style.boxShadow = 'none';

                // ÂÜçÁîü„Éú„Çø„É≥
                this.playButton = DomUtil.create('button', 'leaflet-control-button fontLarge', container);
                this.playButton.innerText = 'Nowcast';
                this.playButton.style.minWidth = '160px';
                DomEvent.on(this.playButton, 'click', playBoth);

                // ÈÄüÂ∫¶„Éú„Çø„É≥
                this.speedButton = DomUtil.create('button', 'leaflet-control-button fontLarge', container);
                this.speedButton.innerText = '2x';
                this.speedButton.style.minWidth = '50px';
                DomEvent.on(this.speedButton, 'click', toggleSpeed);

                return container;
            }

            setPlayText(text) {
                this.playButton.innerText = text;
            }

            setSpeedText(text) {
                this.speedButton.innerText = text;
            }
        }

        var playControl = new PlayControlGroup();
        playControl.addTo(map);

        // nowcastInfo„Å®speedButton„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÅÆ„É©„ÉÉ„Éë„Éº
        nowcastInfo = {
            setText: function (text) { playControl.setPlayText(text); },
            _button: { text: '' }
        };
        speedButton = {
            setText: function (text) { playControl.setSpeedText(text); }
        };

        nowcastButton = createButtonInfo({ position: 'bottomleft', text: 'üåßÔ∏è Nowcast', toggle: true, toggleStatus: true, onClick: toggleNowCast })
        nowcastButton.addTo(map);
        himawariButton = createButtonInfo({ position: 'bottomleft', text: 'üõ∞Ô∏è Himawari', toggle: true, toggleStatus: true, onClick: toggleHimawari })
        himawariButton.addTo(map);

        trueColorButton = createButtonInfo({ position: 'bottomleft', text: 'üåà TrueColor', toggle: true, toggleStatus: true, onClick: toggleTrueColor })
        trueColorButton.addTo(map);

        // map.setView([35.653918,139.857864], 8);

        refreshNowCast();
        refreshHimawari();
        window.setInterval(refreshHimawari, 150000);
        window.setInterval(refreshNowCast, 300000);

        function toggleNowCast() {
            if (nowcastButton.getToggleStatus()) {
                nowcastButton.button.classList.add('toggle-off');
                console.log('toggle to off');
                nowCastLayer.setOpacity(0);
                nowCastLayerArr[0].setOpacity(0);
                nowCastLayerArr[1].setOpacity(0);
            } else {
                nowcastButton.button.classList.remove('toggle-off');
                nowCastLayer.setOpacity(opacityNowCast);
                console.log('toggle to on');
            }
        }
        function toggleHimawari() {
            if (himawariButton.getToggleStatus()) {
                himawariButton.button.classList.add('toggle-off');
                console.log('toggle to off');
                himawariLayer.setOpacity(0);
                himawariLayerArr[0].setOpacity(0);
                himawariLayerArr[1].setOpacity(0);
                // Ë°õÊòüÂÜôÁúü„Å´Âàá„ÇäÊõø„Åà
                map.removeLayer(blankLayer);
                seamlessPhotoLayer.addTo(map);
            } else {
                himawariButton.button.classList.remove('toggle-off');
                himawariLayer.setOpacity(opacityHimawari);
                console.log('toggle to on');
                // ÁôΩÂú∞Âõ≥„Å´Âàá„ÇäÊõø„Åà
                map.removeLayer(seamlessPhotoLayer);
                blankLayer.addTo(map);
            }
        }

        function toggleTrueColor() {
            // ÊâãÂãïÂàáÊõø„Éï„É©„Ç∞„Çí„Çª„ÉÉ„ÉàÔºàËá™ÂãïÂàáÊõø„ÇíÁÑ°ÂäπÂåñÔºâ
            isManualHimawariMode = true;

            if (optHimawari === 'B13/TBB') {
                trueColorButton.setText('üåà TrueColor');
                optHimawari = 'REP/ETC';
            } else {
                trueColorButton.setText('üåô IR');
                optHimawari = 'B13/TBB';
            }
            console.log(`Manual switch to ${optHimawari}`);
            refreshHimawari();
        }

        // ÂÜçÁîüÈÄüÂ∫¶Âàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function toggleSpeed() {
            if (playSpeed === 1) {
                playSpeed = 2;
                speedButton.setText('2x');
            } else if (playSpeed === 2) {
                playSpeed = 4;
                speedButton.setText('4x');
            } else {
                playSpeed = 1;
                speedButton.setText('1x');
            }
            console.log(`Play speed changed to ${playSpeed}x`);
        }

        // Ëá™ÂãïÂàá„ÇäÊõø„ÅàÁî®„ÅÆÈñ¢Êï∞„ÇíËøΩÂä†
        function updateHimawariMode() {
            const now = new Date();
            const hour = now.getHours();
            const isDaytime = hour >= 5 && hour < 18;

            // ÊòºÂ§ú„ÅåÂàá„ÇäÊõø„Çè„Å£„Åü„ÇâËá™ÂãïÂàáÊõø„ÇíÂÜçÊúâÂäπÂåñ
            if (lastIsDaytime !== null && lastIsDaytime !== isDaytime) {
                isManualHimawariMode = false;
                console.log('Auto mode re-enabled by day/night transition');
            }
            lastIsDaytime = isDaytime;

            // ÊâãÂãï„ÅßÂàá„ÇäÊõø„Åà„ÅüÂ†¥Âêà„ÅØËá™ÂãïÂàáÊõø„Åó„Å™„ÅÑ
            if (isManualHimawariMode) {
                return;
            }

            if (isDaytime && optHimawari === 'B13/TBB') {
                // ÊòºÈñì„Å™„ÅÆ„Å´IR„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅTrueColor„Å´Âàá„ÇäÊõø„Åà
                optHimawari = 'REP/ETC';
                trueColorButton.setText('üåà TrueColor');
                console.log('Auto switching to TrueColor (daytime)');
                refreshHimawari();
            } else if (!isDaytime && optHimawari === 'REP/ETC') {
                // Â§úÈñì„Å™„ÅÆ„Å´TrueColor„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅIR„Å´Âàá„ÇäÊõø„Åà
                optHimawari = 'B13/TBB';
                trueColorButton.setText('üåô IR');
                console.log('Auto switching to IR (nighttime)');
                refreshHimawari();
            }
        }

        async function refreshNowCast() {
            isPlay = false;
            nowCastTimeList = await fetch("https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json").then(function (response) {
                return response.json();
            });
            playTimelist = JSON.parse(JSON.stringify(nowCastTimeList));
            playTimelist.sort(function (a, b) {
                return (a.baseTime < b.baseTime ? 1 : -1);
            })

            // console.log(nowCastTimeList);
            const baseTime = nowCastTimeList[0]['basetime'];
            const validTime = nowCastTimeList[0]['validtime'];
            const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");

            console.log(`${new Date()}:${validTime}:${baseTimeDt}`);
            const url = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
            console.log(url);
            if (!nowCastLayer) {
                // 
                console.log(`new nowCastLayer`);
                nowCastLayer = new TileLayer(url, {
                    zIndex: 20, maxNativeZoom: 10, opacity: opacityNowCast,
                    attribution: "<a href='https://www.jma.go.jp/bosai/nowc/' target='_blank'>Èõ®Èõ≤„ÅÆÂãï„Åç</a>"
                });
                nowCastLayer.addTo(map);
                // layerControl.addOverlay(nowCastLayer,`Nowcast`);
                nowCastLayerArr[0] = nowCastLayer;
                nowCastLayerArr[1] = new TileLayer(url, {
                    zIndex: 20, maxNativeZoom: 10, opacity: opacityNowCast,
                    attribution: "<a href='https://www.jma.go.jp/bosai/nowc/' target='_blank'>Èõ®Èõ≤„ÅÆÂãï„Åç</a>"
                });
                nowCastLayerArr[1].setOpacity(0);
                nowCastLayerArr[1].addTo(map);
                // ÂàùÊúü„Ç∫„Éº„É†„É¨„Éô„É´„ÅßmaxNativeZoom„ÇíË®≠ÂÆö
                updateNowCastMaxNativeZoom(map.getZoom());
            } else {
                if (nowcastButton.getToggleStatus()) {
                    if (nowCastLayer === nowCastLayerArr[1]) {
                        nowCastLayer = nowCastLayerArr[0];
                        nowCastLayerArr[0].setOpacity(0);
                        nowCastLayerArr[1].setOpacity(opacityNowCast);
                    } else {
                        nowCastLayer = nowCastLayerArr[1];
                        nowCastLayerArr[1].setOpacity(0);
                        nowCastLayerArr[0].setOpacity(opacityNowCast);
                    }
                }
                console.log(`setUrl nowCastLayer`);
                nowCastLayer.setUrl(url);
                while (nowCastLayer.isLoading()) {
                    await sleep(10);
                }
                if (nowcastButton.getToggleStatus()) {
                    if (nowCastLayer === nowCastLayerArr[1]) {
                        nowCastLayerArr[1].setOpacity(opacityNowCast);
                        nowCastLayerArr[0].setOpacity(0);
                    } else {
                        nowCastLayerArr[0].setOpacity(opacityNowCast);
                        nowCastLayerArr[1].setOpacity(0);
                    }
                }
            }
            nowcastInfo.setText(`‚ñ∂Ô∏è ${baseTimeDt}`);
        }

        // https://www.jma.go.jp/bosai/himawari/data/satimg/20210406040000/jp/20210406040000/B13/TBB/6/54/26.jpg

        async function refreshHimawari() {
            updateHimawariMode(); // Êõ¥Êñ∞ÊôÇ„Å´„É¢„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            isPlay = false;
            himawariTimeList = await fetch("https://www.jma.go.jp/bosai/himawari/data/satimg/targetTimes_jp.json").then(function (response) {
                return response.json();
            });
            // console.log(himawariTimeList);
            const baseTime = himawariTimeList[himawariTimeList.length - 1]['basetime'];
            const validTime = himawariTimeList[himawariTimeList.length - 1]['validtime'];
            const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");
            console.log(`${new Date()}:${validTime}`);
            // const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/SND/ETC/{z}/{x}/{y}.jpg`;
            const url = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/{z}/{x}/{y}.jpg`;
            console.log(url);
            if (!himawariLayer) {
                console.log(`new himawariLayer`);
                himawariLayer = new TileLayer(url, {
                    zIndex: 10, maxNativeZoom: 6, opacity: opacityHimawari,
                    attribution: "<a href='https://www.jma.go.jp/bosai/map.html#5/34.5/137/&elem=strengthen&contents=himawari' target='_blank'>Ê∞óË±°Ë°õÊòü„Å≤„Åæ„Çè„ÇäËµ§Â§ñÁîªÂÉè</a>"
                });
                himawariLayer.addTo(map);
                // layerControl.addOverlay(himawariLayer,`Himawari`);
                himawariLayerArr[0] = himawariLayer;
                himawariLayerArr[1] = new TileLayer(url, {
                    zIndex: 10, maxNativeZoom: 6, opacity: opacityHimawari,
                    attribution: "<a href='https://www.jma.go.jp/bosai/map.html#5/34.5/137/&elem=strengthen&contents=himawari' target='_blank'>Ê∞óË±°Ë°õÊòü„Å≤„Åæ„Çè„ÇäËµ§Â§ñÁîªÂÉè</a>"
                });
                himawariLayerArr[1].setOpacity(0);
                himawariLayerArr[1].addTo(map);
            } else {
                if (himawariButton.getToggleStatus()) {
                    if (himawariLayer === himawariLayerArr[1]) {
                        himawariLayer = himawariLayerArr[0];
                        himawariLayerArr[0].setOpacity(0);
                        himawariLayerArr[1].setOpacity(opacityHimawari);
                    } else {
                        himawariLayer = himawariLayerArr[1];
                        himawariLayerArr[1].setOpacity(0);
                        himawariLayerArr[0].setOpacity(opacityHimawari);
                    }
                }
                console.log(`setUrl himawariLayer`);
                himawariLayer.setUrl(url);
                if (himawariButton.getToggleStatus()) {
                    if (himawariLayer === himawariLayerArr[1]) {
                        himawariLayerArr[0].setOpacity(0);
                        himawariLayerArr[1].setOpacity(opacityHimawari);
                    } else {
                        himawariLayerArr[0].setOpacity(opacityHimawari);
                        himawariLayerArr[1].setOpacity(0);
                    }
                }
            }
            //    himawariInfo.setText(`‚ñ∂:${baseTimeDt}`);

        }

        async function playBoth() {
            if (isPlay) {
                isPlay = false;
                return;
            }
            isPlay = true;

            // ÂÜçÁîüÈñãÂßãÊôÇ„Å´‚è∏„ÇíË°®Á§∫
            nowcastInfo.setText('‚è∏ ...');

            // playSpeedÂàÜ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å™„Åå„Çâ„É´„Éº„ÉóÔºà2x„Å™„Çâ1„Å§È£õ„Å∞„Åó„ÄÅ4x„Å™„Çâ3„Å§È£õ„Å∞„ÅóÔºâ
            for (let i = 0; i < playTimelist.length; i += playSpeed) {
                const time = playTimelist[i];
                try {
                    const baseTime = time['basetime'];
                    const validTime = time['validtime'];
                    const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");

                    // „Éá„Éº„Çø„ÅÆÂ≠òÂú®Á¢∫Ë™ç„Çí‰∫ãÂâç„Å´Ë°å„ÅÜ
                    const nowcastUrl = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/8/227/99.png`;
                    const himawariUrl = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/4/13/6.jpg`;

                    const [nowcastExists, himawariExists] = await Promise.all([
                        fetch(nowcastUrl, { method: 'HEAD' }).then(res => res.ok).catch(() => false),
                        fetch(himawariUrl, { method: 'HEAD' }).then(res => res.ok).catch(() => false)
                    ]);

                    if (!nowcastExists || !himawariExists) {
                        console.log(`Skipping frame due to missing data: ${baseTimeDt}`);
                        continue;
                    }

                    // „Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Åø„É¨„Ç§„É§„Éº„ÇíÊõ¥Êñ∞
                    const fullNowcastUrl = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${baseTime}/none/${validTime}/surf/hrpns/{z}/{x}/{y}.png`;
                    const fullHimawariUrl = `https://www.jma.go.jp/bosai/himawari/data/satimg/${baseTime}/jp/${validTime}/${optHimawari}/{z}/{x}/{y}.jpg`;

                    if (nowcastButton.getToggleStatus()) {
                        if (nowCastLayer === nowCastLayerArr[0]) {
                            nowCastLayer = nowCastLayerArr[1];
                            nowCastLayerArr[1].setOpacity(0);
                            nowCastLayerArr[0].setOpacity(opacityNowCast);
                        } else {
                            nowCastLayer = nowCastLayerArr[0];
                            nowCastLayerArr[0].setOpacity(0);
                            nowCastLayerArr[1].setOpacity(opacityNowCast);
                        }
                    }
                    if (himawariButton.getToggleStatus()) {
                        if (himawariLayer === himawariLayerArr[0]) {
                            himawariLayer = himawariLayerArr[1];
                            himawariLayerArr[1].setOpacity(0);
                            himawariLayerArr[0].setOpacity(opacityHimawari);
                        } else {
                            himawariLayer = himawariLayerArr[0];
                            himawariLayerArr[0].setOpacity(0);
                            himawariLayerArr[1].setOpacity(opacityHimawari);
                        }
                    }

                    // URL„ÅÆË®≠ÂÆö„Å®Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæÖ„Å°
                    const loadPromises = [];
                    if (nowcastExists) {
                        nowCastLayer.setUrl(fullNowcastUrl);
                        loadPromises.push(waitForLayerLoad(nowCastLayer));
                    }
                    if (himawariExists) {
                        himawariLayer.setUrl(fullHimawariUrl);
                        loadPromises.push(waitForLayerLoad(himawariLayer));
                    }

                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„ÅßË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Loading timeout')), 5000)
                    );

                    await Promise.race([
                        Promise.all(loadPromises),
                        timeoutPromise
                    ]).catch(error => {
                        console.warn('Layer loading error:', error);
                        return false;
                    });

                    await sleep(500);
                    if (!isPlay) break;

                    nowcastInfo.setText(`‚è∏ ${baseTimeDt}`);

                } catch (error) {
                    console.warn('Error in animation frame:', error);
                    continue; // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åü„Éï„É¨„Éº„É†„Çí„Çπ„Ç≠„ÉÉ„Éó
                }
            }

            // ÊúÄÂæå„ÅÆ„Éï„É¨„Éº„É†„ÅÆÈÄèÊòéÂ∫¶„ÇíÈÅ©Âàá„Å´Ë®≠ÂÆö
            if (nowcastButton.getToggleStatus()) {
                if (nowCastLayer === nowCastLayerArr[0]) {
                    nowCastLayerArr[0].setOpacity(opacityNowCast);
                    nowCastLayerArr[1].setOpacity(0);
                } else {
                    nowCastLayerArr[1].setOpacity(opacityNowCast);
                    nowCastLayerArr[0].setOpacity(0);
                }
            }
            if (himawariButton.getToggleStatus()) {
                if (himawariLayer === himawariLayerArr[0]) {
                    himawariLayerArr[0].setOpacity(opacityHimawari);
                    himawariLayerArr[1].setOpacity(0);
                } else {
                    himawariLayerArr[1].setOpacity(opacityHimawari);
                    himawariLayerArr[0].setOpacity(0);
                }
            }
            isPlay = false;

            // ÂÜçÁîüÁµÇ‰∫ÜÂæå„Å´‚ñ∂„Å®ÊúÄÊñ∞ÊôÇÂàª„ÇíË°®Á§∫
            if (nowCastTimeList && nowCastTimeList.length > 0) {
                const baseTime = nowCastTimeList[0]['basetime'];
                const baseTimeDt = moment(baseTime + " +0000", "YYYYMMDDHHmmss Z").format("HH:mm");
                nowcastInfo.setText(`‚ñ∂Ô∏è ${baseTimeDt}`);
            } else {
                nowcastInfo.setText('‚ñ∂Ô∏è --:--');
            }
        }

        // „É¨„Ç§„É§„Éº„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function waitForLayerLoad(layer) {
            return new Promise((resolve) => {
                if (!layer.isLoading()) {
                    resolve();
                    return;
                }
                const checkLoading = async () => {
                    while (layer.isLoading()) {
                        await sleep(10);
                    }
                    resolve();
                };
                checkLoading();
            });
        }

        // ÂàùÊúüÂåñÊôÇ„Å´„É¢„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊó¢Â≠ò„ÅÆ„Ç≥„Éº„Éâ„ÅÆÂæå„Å´ËøΩÂä†Ôºâ
        updateHimawariMode();

        // ÂÆöÊúüÁöÑ„Å™„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËøΩÂä†Ôºà5ÂàÜ„Åî„Å®Ôºâ
        window.setInterval(updateHimawariMode, 300000);

        // „Éû„Éº„Ç´„Éº„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÅÆË®≠ÂÆö
        [
            [34.819916, 135.504041], // ÈùíÂ±±Âè∞
            [37.014244, 138.652698], // Ê¥•Âçó
            [36.881936, 138.638919]  // Â§ßËµ§Ê≤¢
        ].forEach(coords => {
            new CircleMarker(coords, { radius: 7, color: '#800000' }).addTo(map);
        });

    </script>
</body>

</html>